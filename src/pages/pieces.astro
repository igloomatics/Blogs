---
import BaseLayout from '../layouts/BaseLayout.astro';

// åœ¨æ„å»ºæ—¶è·å– Status Cafe çš„ Atom feed
const username = 'igloos';
let statuses = [];

try {
  const response = await fetch(`https://status.cafe/users/${username}.atom`);
  const text = await response.text();
  
  // HTML å®ä½“è§£ç å‡½æ•°
  function decodeHTMLEntities(text: string): string {
    const entities: Record<string, string> = {
      '&amp;': '&',
      '&lt;': '<',
      '&gt;': '>',
      '&quot;': '"',
      '&#39;': "'",
      '&apos;': "'"
    };
    
    let decoded = text.replace(/&[a-z]+;/gi, match => entities[match] || match);
    decoded = decoded.replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(parseInt(dec, 10)));
    decoded = decoded.replace(/&#x([0-9a-f]+);/gi, (match, hex) => String.fromCharCode(parseInt(hex, 16)));
    
    return decoded;
  }
  
  // ç®€å•çš„ XML è§£æï¼ˆæå– entry æ ‡ç­¾ï¼‰
  const entryRegex = /<entry>([\s\S]*?)<\/entry>/g;
  const titleRegex = /<title>([\s\S]*?)<\/title>/;
  const contentRegex = /<content type="html">([\s\S]*?)<\/content>/;
  const updatedRegex = /<updated>(.*?)<\/updated>/;
  
  let match;
  while ((match = entryRegex.exec(text)) !== null) {
    const entry = match[1];
    const titleMatch = entry.match(titleRegex);
    const contentMatch = entry.match(contentRegex);
    const updatedMatch = entry.match(updatedRegex);
    
    if (titleMatch && contentMatch && updatedMatch) {
      const titleText = titleMatch[1];
      
      // title æ ¼å¼: "igloos ğŸ¥° content"
      // æå– igloos ä¹‹åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼ˆè¡¨æƒ…ï¼‰
      const afterUsername = titleText.substring(titleText.indexOf('igloos') + 'igloos'.length).trim();
      // ä½¿ç”¨ Array.from æ­£ç¡®å¤„ç†å¤šå­—èŠ‚ emoji
      const chars = Array.from(afterUsername);
      const emoji = chars[0] || 'ğŸ“';
      
      // ä» content è·å–å®Œæ•´å†…å®¹
      const content = decodeHTMLEntities(contentMatch[1]);
      
      // æ ¼å¼åŒ–æ—¶é—´
      const date = new Date(updatedMatch[1]);
      const now = new Date();
      const diffMs = now - date;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      let timeAgo;
      if (diffDays === 0) {
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        timeAgo = diffHours === 0 ? 'åˆšåˆš' : `${diffHours} å°æ—¶å‰`;
      } else if (diffDays === 1) {
        timeAgo = '1 å¤©å‰';
      } else if (diffDays < 7) {
        timeAgo = `${diffDays} å¤©å‰`;
      } else {
        timeAgo = date.toLocaleDateString('zh-CN');
      }
      
      statuses.push({
        emoji,
        content,
        timeAgo,
        date: date.toISOString()
      });
    }
  }
} catch (error) {
  console.error('Failed to fetch Status Cafe feed:', error);
}
---

<BaseLayout title="Pieces | ç¢ç‰‡" activeNav="pieces">
    <div class="divider-diamond">
        <span>â—†</span><span>â—†</span><span>â—†</span>
    </div>

    <!-- Status Cafe Section -->
    <div id="statuscafe">
        <div id="statuscafe-content">
            {statuses.length > 0 ? (
                statuses.map(status => (
                    <div class="status-item">
                        <div class="status-header">
                            <a href={`https://status.cafe/users/${username}`} target="_blank" class="status-user">igloos</a>
                            <span class="status-face">{status.emoji}</span>
                            <span class="status-time">{status.timeAgo}</span>
                        </div>
                        <div class="status-content" set:html={status.content}></div>
                    </div>
                ))
            ) : (
                <p>æš‚æ— çŠ¶æ€</p>
            )}
        </div>
    </div>

    <div style="height: 100px;"></div>
</BaseLayout>

<style>
    .divider-diamond { display: flex; justify-content: center; align-items: center; gap: 8px; color: #1a3c5e; font-size: 12px; margin: 20px 0 50px 0; opacity: 0.9; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Status Cafe Styles */
    #statuscafe {
        margin: 40px 0;
        position: relative;
        font-size: 1rem;
        color: #444;
        animation: fadeIn 0.5s ease;
    }

    #statuscafe-content {
        margin: 0;
        line-height: 1.6;
    }
    
    .status-item {
        padding: 20px 25px;
        margin-bottom: 25px;
        /* ç£¨ç ‚ç»ç’ƒæè´¨æ•ˆæœ */
        background-color: rgba(255, 255, 255, 0.45);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 16px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    
    .status-item:hover {
        transform: translateY(-4px);
        background-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 12px 40px rgba(118, 159, 205, 0.15);
        border-color: rgba(255, 255, 255, 0.8);
    }
    
    .status-item:last-child {
        margin-bottom: 0;
    }
    
    .status-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .status-user {
        font-size: 1.05rem;
        /* ç»§æ‰¿å…¨å±€ a æ ‡ç­¾æ ·å¼ï¼šåŠ ç²—ã€é¢œè‰²ã€ä¸‹åˆ’çº¿ */
    }
    
    .status-user:hover {
        /* ç»§æ‰¿å…¨å±€ hover æ•ˆæœ */
    }
    
    .status-face {
        font-size: 1.3em;
    }
    
    .status-time {
        font-size: 0.85em;
        color: #666;
        font-weight: normal;
        margin-left: auto; /* æ—¶é—´é å³æ˜¾ç¤ºï¼Œæ›´æœ‰è®¾è®¡æ„Ÿ */
    }
    
    .status-content {
        color: #444;
        line-height: 1.7;
        font-variant-numeric: normal;
        font-feature-settings: normal;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, "LXGW WenKai Screen", "LXGW WenKai", sans-serif;
    }
</style>
---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

// 获取所有文章并按日期倒序排序
const allPosts = await getCollection('posts');
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// 按年份分组
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = post.data.date.split('-')[0];
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<string, typeof allPosts>);

// 获取排序后的年份列表
const years = Object.keys(postsByYear).sort((a, b) => b.localeCompare(a));
---

<BaseLayout title="Time | 时光" activeNav="time">
    {years.map((year) => (
        <div class="archive-year-section">
            <div class="archive-header">
                {year} <span>/ {postsByYear[year].length} entries</span>
            </div>

            <ul class="archive-list">
                {postsByYear[year].map((post) => (
                    <li class="archive-item">
                        <span class="archive-date">{post.data.date.substring(5)}</span>
                        <a href={`/posts/${post.slug}`} class="archive-title">{post.data.title}</a>
                        <div class="archive-tags">
                            {post.data.tags.map(tag => (
                                <a href={`/tags/${tag}`} class="tag">{tag}</a>
                            ))}
                        </div>
                    </li>
                ))}
            </ul>
        </div>
    ))}
    
    {years.length === 0 && (
        <p style="text-align: center; color: var(--text-light); margin-top: 50px;">
            暂无文章存档 ✨
        </p>
    )}
    
    <div style="height: 100px;"></div>
</BaseLayout>

<style>
    .archive-year-section { margin-bottom: 50px; }
    .archive-header { font-size: 1.8rem; font-weight: bold; color: var(--text-main); margin-top: 20px; margin-bottom: 30px; letter-spacing: 1px; text-shadow: 0 2px 10px rgba(255, 255, 255, 0.6); }
    .archive-header span { font-size: 1.2rem; font-weight: normal; color: var(--text-light); margin-left: 5px; }
    .archive-list { list-style: none; width: 100%; }
    .archive-item { display: flex; align-items: baseline; padding: 12px 0; border-bottom: 1px dashed rgba(185, 215, 234, 0.4); }
    .archive-item:hover { background-color: rgba(255, 255, 255, 0.6); border-radius: 6px; padding-left: 10px; padding-right: 10px; margin-left: -10px; margin-right: -10px; }
    
    /* 这里的样式同步自首页 index.astro 喵 */
    .archive-date { 
        width: 80px; 
        flex-shrink: 0; 
        color: var(--text-light); 
        font-size: 0.85rem; 
        font-family: monospace; 
        letter-spacing: -0.5px; 
    }
    
    .archive-title { 
        flex: 1; 
        color: var(--text-main); 
        text-decoration: none; 
        font-size: 1rem; 
        font-weight: bold; 
        margin-right: 20px; 
        transition: all 0.2s; 
        line-height: 1.4;
    }
    
    .archive-title:hover { 
        color: var(--col-4-dark); 
    }
    
    .archive-tags { display: flex; gap: 6px; flex-shrink: 0; }

    @media (max-width: 768px) {
        .archive-item { flex-wrap: wrap; }
        .archive-tags { margin-left: 80px; margin-top: 5px; width: 100%; }
    }
</style>
